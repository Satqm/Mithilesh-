<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Classes - Mr. Mithilesh</title>
    <link rel="manifest" href="manifest.json">
    <!-- Firebase & UI Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #7c3aed;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --border: #e2e8f0;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --elevation-1: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --elevation-2: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--dark);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 48px;
            width: 100%;
            max-width: 440px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-section {
            margin-bottom: 40px;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 36px;
        }

        .logo-title {
            font-family: 'Poppins', sans-serif;
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .logo-subtitle {
            color: var(--gray);
            font-size: 16px;
        }

        .login-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 32px;
        }

        .option-card {
            background: var(--light);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
        }

        .option-card:hover {
            background: white;
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--elevation-2);
        }

        .option-card i {
            font-size: 32px;
            margin-bottom: 16px;
            color: var(--primary);
        }

        .option-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .option-card p {
            color: var(--gray);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
            font-size: 14px;
        }

        .form-label.required::after {
            content: " *";
            color: var(--danger);
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Header */
        .app-header {
            background: white;
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--border);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
        }

        .user-details h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-details p {
            color: var(--gray);
            font-size: 14px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: var(--radius-lg);
            overflow-x: auto;
            margin-bottom: 24px;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--border);
            padding: 4px;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            color: var(--gray);
        }

        .nav-tab:hover {
            background: var(--light);
            color: var(--primary);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: var(--card-shadow);
        }

        .nav-tab i {
            margin-right: 8px;
            font-size: 16px;
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--border);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--elevation-2);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 16px;
        }

        .stat-title {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
        }

        .stat-trend {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 8px;
        }

        .trend-up {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .trend-down {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--dark);
        }

        .section-title i {
            margin-right: 12px;
            color: var(--primary);
        }

        /* Student Cards */
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .student-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .student-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--elevation-2);
        }

        .student-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .student-avatar {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            margin-right: 16px;
        }

        .student-info h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .student-info p {
            color: var(--gray);
            font-size: 14px;
        }

        .student-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .detail-item {
            background: var(--light);
            padding: 12px;
            border-radius: var(--radius-md);
            border-left: 3px solid var(--primary);
        }

        .detail-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--light);
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
        }

        .table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .table tr:hover {
            background: var(--light);
        }

        /* Badges */
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        /* Test Cards */
        .tests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .test-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .test-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--elevation-2);
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .test-class {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .test-meta {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .test-actions {
            display: flex;
            gap: 12px;
        }

        /* Feedback */
        .feedback-container {
            background: white;
            border-radius: var(--radius-lg);
            padding: 32px;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--border);
        }

        .feedback-form {
            background: var(--light);
            padding: 32px;
            border-radius: var(--radius-lg);
            margin-bottom: 32px;
            border: 2px dashed var(--primary-light);
        }

        .form-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--dark);
        }

        .star-rating {
            display: flex;
            gap: 8px;
            margin: 16px 0;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 28px;
            color: #e5e7eb;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #fbbf24;
        }

        .rating-text {
            text-align: center;
            margin-top: 12px;
            color: var(--gray);
            font-size: 14px;
            min-height: 20px;
        }

        .feedback-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .feedback-item {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            transition: transform 0.3s ease;
        }

        .feedback-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .feedback-author h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .feedback-date {
            color: var(--gray);
            font-size: 12px;
        }

        .feedback-stars {
            color: #fbbf24;
            font-size: 16px;
        }

        .feedback-content {
            color: var(--dark);
            font-size: 15px;
            line-height: 1.6;
        }

        /* About Section */
        .about-container {
            background: white;
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--elevation-1);
            border: 1px solid var(--border);
        }

        .teacher-profile {
            text-align: center;
            margin-bottom: 48px;
        }

        .teacher-photo {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 0 auto 24px;
            overflow: hidden;
            border: 6px solid white;
            box-shadow: var(--elevation-2);
        }

        .teacher-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .teacher-info h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .teacher-info p {
            color: var(--gray);
            font-size: 18px;
            margin-bottom: 24px;
        }

        .contact-info {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: var(--light);
            border-radius: var(--radius-lg);
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .contact-item:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .contact-item i {
            font-size: 16px;
        }

        .qualification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .qualification-card {
            background: var(--light);
            padding: 24px;
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s ease;
        }

        .qualification-card:hover {
            transform: translateY(-4px);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--dark);
        }

        .card-title i {
            margin-right: 10px;
            color: var(--primary);
        }

        .qualification-list {
            list-style: none;
        }

        .qualification-list li {
            padding: 8px 0;
            color: var(--dark);
            position: relative;
            padding-left: 24px;
        }

        .qualification-list li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            display: none;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background: white;
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.4s ease;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .modal-header button {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .modal-header button:hover {
            background: var(--light);
        }

        .modal-body {
            padding: 24px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--gray);
        }

        .loading i {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--elevation-2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Student View Notice */
        .view-notice {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 16px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--card-shadow);
        }

        .view-notice i {
            font-size: 20px;
        }

        .view-notice strong {
            font-weight: 600;
        }

        .view-notice p {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 4px;
        }

        /* Search */
        .search-box {
            position: relative;
            margin-bottom: 24px;
        }

        .search-box i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .search-box input {
            padding-left: 48px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Attendance Status */
        .attendance-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-present {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-absent {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .login-card {
                padding: 32px 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .students-grid,
            .tests-grid {
                grid-template-columns: 1fr;
            }

            .nav-tab {
                min-width: 100px;
                padding: 12px 8px;
                font-size: 13px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .contact-info {
                flex-direction: column;
                align-items: center;
            }

            .teacher-photo {
                width: 150px;
                height: 150px;
            }

            .teacher-info h1 {
                font-size: 28px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--gray);
        }

        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .mb-4 { margin-bottom: 32px; }

        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mt-4 { margin-top: 32px; }

        .p-1 { padding: 8px; }
        .p-2 { padding: 16px; }
        .p-3 { padding: 24px; }
        .p-4 { padding: 32px; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-square-root-alt"></i>
                </div>
                <h1 class="logo-title">Math Classes</h1>
                <p class="logo-subtitle">Excellence in Mathematics by Mr. Mithilesh</p>
            </div>
            
            <div class="login-options">
                <div class="option-card" onclick="showTeacherLogin()">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h3>Teacher Login</h3>
                    <p>Full access to dashboard, student management, and analytics</p>
                </div>
                
                <div class="option-card" onclick="enterStudentMode()">
                    <i class="fas fa-user-graduate"></i>
                    <h3>Student Access</h3>
                    <p>View classes, download materials, and submit feedback</p>
                </div>
            </div>

            <div id="teacherLoginForm" class="hidden mt-4">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="teacher@example.com" value="mithilesh.maths@gmail.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
                <button class="btn btn-secondary mt-2" onclick="showLoginOptions()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="container hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">M</div>
                    <div class="user-details">
                        <h2 id="welcomeMessage">Welcome!</h2>
                        <p id="userRole">Loading...</p>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Student View Notice -->
        <div id="studentNotice" class="view-notice hidden">
            <i class="fas fa-user-graduate"></i>
            <div>
                <strong>STUDENT VIEW MODE</strong>
                <p>Read-only access to view information and submit feedback</p>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <div class="nav-tab active" onclick="showSection('dashboard')">
                <i class="fas fa-chart-line"></i> Dashboard
            </div>
            <div class="nav-tab" onclick="showSection('students')">
                <i class="fas fa-users"></i> Students
            </div>
            <div class="nav-tab" onclick="showSection('attendance')">
                <i class="fas fa-calendar-check"></i> Attendance
            </div>
            <div class="nav-tab" onclick="showSection('tests')">
                <i class="fas fa-file-alt"></i> Tests
            </div>
            <div class="nav-tab" onclick="showSection('feedback')">
                <i class="fas fa-star"></i> Feedback
            </div>
            <div class="nav-tab" onclick="showSection('about')">
                <i class="fas fa-user-tie"></i> Teacher
            </div>
        </nav>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div>
                            <div class="stat-title">Total Students</div>
                            <div class="stat-value" id="totalStudents">0</div>
                            <span class="stat-trend trend-up">Active</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div>
                            <div class="stat-title">Today's Attendance</div>
                            <div class="stat-value" id="attendancePercent">0%</div>
                            <span class="stat-trend trend-up">Good</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <div>
                            <div class="stat-title">Monthly Fees</div>
                            <div class="stat-value" id="feesCollected">₹0</div>
                            <span class="stat-trend trend-up">Collected</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div>
                            <div class="stat-title">Pending Fees</div>
                            <div class="stat-value" id="pendingFees">₹0</div>
                            <span class="stat-trend trend-down">Pending</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-history"></i> Recent Activities</h2>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Activity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="activitiesList">
                        <tr><td colspan="3" class="text-center p-4">Loading activities...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Students Section -->
        <section id="students" class="content-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-users"></i> Students</h2>
                <button class="btn btn-primary" onclick="openAddStudentModal()" id="addStudentBtn">
                    <i class="fas fa-plus"></i> Add Student
                </button>
            </div>

            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="studentSearch" class="form-control" placeholder="Search students by name, class, or father's name...">
            </div>

            <div id="studentsList" class="students-grid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading students...</p>
                </div>
            </div>
        </section>

        <!-- Attendance Section -->
        <section id="attendance" class="content-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-calendar-check"></i> Attendance</h2>
                <div id="attendanceActions">
                    <button class="btn btn-primary" onclick="openAttendanceModal()">
                        <i class="fas fa-check"></i> Mark Today
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Class</th>
                            <th>Today</th>
                            <th>This Week</th>
                            <th>This Month</th>
                            <th>Overall %</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTable">
                        <tr><td colspan="6" class="text-center p-4">Loading attendance...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Tests Section -->
        <section id="tests" class="content-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-file-alt"></i> Tests & Materials</h2>
                <button class="btn btn-primary" onclick="openAddTestModal()" id="addTestBtn">
                    <i class="fas fa-plus"></i> Add Test
                </button>
            </div>

            <div id="testsList" class="tests-grid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading tests...</p>
                </div>
            </div>
        </section>

        <!-- Feedback Section -->
        <section id="feedback" class="content-section">
            <div class="feedback-container">
                <div class="feedback-form">
                    <h3 class="form-title"><i class="fas fa-comment-alt"></i> Submit Feedback</h3>
                    <div class="form-group">
                        <label class="form-label required">Your Name</label>
                        <input type="text" id="feedbackName" class="form-control" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" id="feedbackPhone" class="form-control" placeholder="Enter your phone number">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Rating</label>
                        <div class="star-rating">
                            <input type="radio" id="star5" name="rating" value="5">
                            <label for="star5">★</label>
                            <input type="radio" id="star4" name="rating" value="4">
                            <label for="star4">★</label>
                            <input type="radio" id="star3" name="rating" value="3">
                            <label for="star3">★</label>
                            <input type="radio" id="star2" name="rating" value="2">
                            <label for="star2">★</label>
                            <input type="radio" id="star1" name="rating" value="1">
                            <label for="star1">★</label>
                        </div>
                        <div class="rating-text" id="ratingText">Select your rating</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comments</label>
                        <textarea id="feedbackText" class="form-control" rows="4" placeholder="Share your feedback or suggestions..."></textarea>
                    </div>
                    <button class="btn btn-success" onclick="submitFeedback()">
                        <i class="fas fa-paper-plane"></i> Submit Feedback
                    </button>
                </div>

                <div class="mt-4">
                    <h3 class="form-title"><i class="fas fa-list"></i> Recent Feedback</h3>
                    <div class="feedback-list" id="feedbackList">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading feedback...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

<!-- About Teacher Section -->
<section id="about" class="content-section">
    <div class="about-container">
        <div class="teacher-profile">
            <div class="teacher-photo">
                <img src="https://raw.githubusercontent.com/Satqm/Mithilesh-/main/Mithilesh.jpg" 
                     alt="Mr. Mithilesh" 
                     id="teacherImage"
                     onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=Mr+Mithilesh&background=4f46e5&color=fff&size=200'">
            </div>
            <div class="teacher-info">
                <h1 id="teacherName">Mr. Mithilesh</h1>
                <p id="teacherTitle">Senior Mathematics Teacher & Mentor</p>
                <div class="contact-info">
                    <a href="https://wa.me/919334420038" class="contact-item" target="_blank">
                        <i class="fab fa-whatsapp"></i>
                        <span>+91 93344 20038</span>
                    </a>
                    <a href="mailto:mithilesh.2835@gmail.com" class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span id="teacherEmail">mithilesh.2835@gmail.com</span>
                    </a>
                    <a href="https://youtube.com/@bihari_mithlesh?si=aQ3SivuQLkbmQ4Cq" class="contact-item" target="_blank">
                        <i class="fab fa-youtube"></i>
                        <span>YouTube Channel</span>
                    </a>
                </div>
            </div>
        </div>

        <div class="qualification-grid mt-4">
            <div class="qualification-card">
                <h3 class="card-title"><i class="fas fa-graduation-cap"></i> Qualifications</h3>
                <ul class="qualification-list" id="qualificationsList">
                    <li>M.Sc. Mathematics</li>
                    <li>B.Ed. in Mathematics Education</li>
                </ul>
            </div>
            <div class="qualification-card">
                <h3 class="card-title"><i class="fas fa-chart-line"></i> Experience</h3>
                <p id="experienceText" class="mb-2">25+ years specializing in CBSE, ICSE, Bihar Board Mathematics for classes 9-12.</p>
                <div class="mb-2">
                    <strong>Specializations:</strong>
                    <ul class="qualification-list">
                        <li>Algebra & Calculus</li>
                        <li>Geometry & Trigonometry</li>
                        <li>Statistics & Probability</li>
                    </ul>
                </div>
            </div>
            <div class="qualification-card">
                <h3 class="card-title"><i class="fas fa-trophy"></i> Achievements</h3>
                <ul class="qualification-list" id="achievementsList">
                    <li>10000+ Students Taught</li>
                    <li>95%+ Board Exam Success Rate</li>
                    <li>500+ JNV Selections</li>
                    <li>Best Teacher Award 2018</li>
                    <li>National Science Recognition:Japan Exposure Tour
                </ul>
            </div>
        </div>
    </div>
</section>
    </div>
    <!-- Modals -->
    <div class="modal-overlay" id="addStudentModal">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Add New Student</h3>
            <button onclick="closeModal('addStudentModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label required">Student Name</label>
                <input type="text" id="studentName" class="form-control" placeholder="Enter full name">
            </div>
            <div class="form-group">
                <label class="form-label required">Father's Name</label>
                <input type="text" id="fatherName" class="form-control" placeholder="Enter father's name">
            </div>
            <div class="form-group">
                <label class="form-label required">Class</label>
                <select id="studentClass" class="form-control">
                    <option value="" disabled selected>Select Grade</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                    <option value="7">Grade 7</option>
                    <option value="8">Grade 8</option>
                    <option value="9">Grade 9</option>
                    <option value="10">Grade 10</option>
                    <option value="11">Grade 11</option>
                    <option value="12">Grade 12</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label required">Mobile Number</label>
                <input type="tel" id="studentMobile" class="form-control" placeholder="Enter mobile number">
            </div>
            <div class="form-group">
                <label class="form-label required">Monthly Fee (₹)</label>
                <input type="number" id="monthlyFee" class="form-control" placeholder="3500">
            </div>
            <button class="btn btn-primary" onclick="addStudent()">
                <i class="fas fa-save"></i> Save Student
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="addTestModal">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-file-upload"></i> Add Test Material</h3>
            <button onclick="closeModal('addTestModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label required">Test Title</label>
                <input type="text" id="testTitle" class="form-control" placeholder="Enter test title">
            </div>
            <div class="form-group">
                <label class="form-label required">For Class</label>
                <select id="testClass" class="form-control">
                    <option value="all">All Classes</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                    <option value="7">Grade 7</option>
                    <option value="8">Grade 8</option>
                    <option value="9">Grade 9</option>
                    <option value="10">Grade 10</option>
                    <option value="11">Grade 11</option>
                    <option value="12">Grade 12</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label required">Test Date</label>
                <input type="date" id="testDate" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label required">PDF Link</label>
                <input type="url" id="testLink" class="form-control" placeholder="https://drive.google.com/...">
            </div>
            <button class="btn btn-primary" onclick="addTest()">
                <i class="fas fa-save"></i> Save Test
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="attendanceModal">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-check"></i> Mark Attendance</h3>
            <button onclick="closeModal('attendanceModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="attendanceList">
                </div>
            <button class="btn btn-success mt-3" onclick="saveAttendance()">
                <i class="fas fa-save"></i> Save Attendance
            </button>
        </div>
    </div>
</div>


    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Success!</span>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGYTU5iVTB7nY5poEH1FIeSyDvc9Io9sw",
            authDomain: "math-classes-by-mithilesh.firebaseapp.com",
            projectId: "math-classes-by-mithilesh",
            storageBucket: "math-classes-by-mithilesh.firebasestorage.app",
            messagingSenderId: "1095462608716",
            appId: "1:1095462608716:web:45667272a197a63fed79e9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global State
        let currentUser = null;
        let userRole = null;
        const TEACHER_PASSWORD = "S@tyam";
        let allStudents = [];
        let todayAttendance = {};

        // Initialize App
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize star rating
            document.getElementById('ratingText').textContent = 'Select your rating';
            document.getElementById('toast').style.display = 'none';
            
            // Setup rating text change
            document.querySelectorAll('.star-rating input').forEach(input => {
                input.addEventListener('change', function() {
                    const ratingText = document.getElementById('ratingText');
                    const ratings = {
                        1: 'Poor - Needs improvement',
                        2: 'Fair - Below expectations',
                        3: 'Good - Met expectations',
                        4: 'Very Good - Exceeded expectations',
                        5: 'Excellent - Outstanding'
                    };
                    ratingText.textContent = ratings[this.value] || 'Select your rating';
                });
            });
            
            // Check authentication state
            await checkAuthState();
        });

        // Check authentication state
        async function checkAuthState() {
            try {
                // First check local storage for student mode
                const userMode = localStorage.getItem('userMode');
                
                if (userMode === 'student') {
                    // Student mode
                    userRole = 'student';
                    showApp();
                    await loadStudentData();
                    return;
                }
                
                // Check Firebase auth state
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // Teacher is signed in
                        currentUser = user;
                        await handleAuthenticatedUser();
                    } else {
                        // No user is signed in
                        showLoginScreen();
                    }
                });
            } catch (error) {
                console.error('Error checking auth state:', error);
                showLoginScreen();
            }
        }

        async function handleAuthenticatedUser() {
            try {
                // Get user document from Firestore
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userRole = userData.role || 'teacher';
                } else {
                    // Create user document if it doesn't exist
                    await db.collection('users').doc(currentUser.uid).set({
                        name: 'Mr. Mithilesh',
                        email: currentUser.email,
                        role: 'teacher',
                        createdAt: new Date(),
                        lastLogin: new Date()
                    });
                    userRole = 'teacher';
                    
                    // Also create teacher profile if it doesn't exist
                    await createTeacherProfile();
                }
                
                localStorage.setItem('userMode', 'teacher');
                localStorage.setItem('teacherLoggedIn', 'true');
                
                showApp();
                await loadTeacherData();
                
            } catch (error) {
                console.error('Error handling authenticated user:', error);
                showToast('Error loading user data. Please try again.');
                showLoginScreen();
            }
        }

        async function createTeacherProfile() {
            try {
                const profileDoc = await db.collection('teacherProfile').doc('profile').get();
                if (!profileDoc.exists) {
                    await db.collection('teacherProfile').doc('profile').set({
                        name: 'Mr. Mithilesh',
                        email: currentUser.email,
                        phone: '+91 93344 20038',
                        experience: '12+ years of teaching experience specializing in CBSE, ICSE, and State Board Mathematics.',
                        qualifications: [
                            'M.Sc. Mathematics (Gold Medalist)',
                            'B.Ed. in Mathematics Education',
                            'CTET Qualified (Mathematics)',
                            'NET/JRF Qualified',
                            'Ph.D. in Mathematics (Pursuing)'
                        ],
                        achievements: [
                            '1000+ Students Taught',
                            '95%+ Board Exam Success Rate',
                            '50+ JEE Advanced Selections',
                            'Best Teacher Award 2022',
                            'Student Satisfaction: 4.8/5'
                        ],
                        photoUrl: 'https://raw.githubusercontent.com/Satqm/Mithilesh-/main/Mithilesh.jpg'
                    });
                }
            } catch (error) {
                console.error('Error creating teacher profile:', error);
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            document.querySelector('.login-options').classList.remove('hidden');
            document.getElementById('teacherLoginForm').classList.add('hidden');
        }

        // Login Functions
        function showTeacherLogin() {
            document.querySelector('.login-options').classList.add('hidden');
            document.getElementById('teacherLoginForm').classList.remove('hidden');
        }

        function showLoginOptions() {
            document.querySelector('.login-options').classList.remove('hidden');
            document.getElementById('teacherLoginForm').classList.add('hidden');
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email) {
                showToast('Please enter email address');
                return;
            }

            if (password !== TEACHER_PASSWORD) {
                showToast('Incorrect password');
                return;
            }

            try {
                showLoadingState('Logging in...');
                
                // Try to sign in with existing account
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Update user document
                await db.collection('users').doc(currentUser.uid).set({
                    lastLogin: new Date()
                }, { merge: true });
                
                // Handle the authenticated user
                await handleAuthenticatedUser();
                
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    // Create new teacher account
                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        currentUser = userCredential.user;
                        
                        // Create user document
                        await db.collection('users').doc(currentUser.uid).set({
                            name: 'Mr. Mithilesh',
                            email: email,
                            role: 'teacher',
                            createdAt: new Date(),
                            lastLogin: new Date()
                        });

                        // Create teacher profile
                        await createTeacherProfile();

                        showToast('Teacher account created successfully!');
                        
                        // Handle the authenticated user
                        await handleAuthenticatedUser();
                        
                    } catch (createError) {
                        console.error('Error creating account:', createError);
                        showToast('Error creating account: ' + createError.message);
                        showLoginScreen();
                    }
                } else {
                    console.error('Login error:', error);
                    showToast('Login error: ' + error.message);
                    showLoginScreen();
                }
            }
        }

        function enterStudentMode() {
            // Sign out any existing auth
            auth.signOut();
            
            userRole = 'student';
            localStorage.setItem('userMode', 'student');
            localStorage.removeItem('teacherLoggedIn');
            
            showApp();
            loadStudentData();
            showToast('Welcome to Student View!');
        }

        // App Functions
        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            if (userRole === 'teacher') {
                document.getElementById('welcomeMessage').textContent = 'Welcome, Teacher!';
                document.getElementById('userRole').textContent = 'Teacher Dashboard';
                document.getElementById('userAvatar').textContent = 'T';
                document.getElementById('studentNotice').classList.add('hidden');
                document.getElementById('addStudentBtn').classList.remove('hidden');
                document.getElementById('addTestBtn').classList.remove('hidden');
                document.getElementById('attendanceActions').classList.remove('hidden');
            } else {
                document.getElementById('welcomeMessage').textContent = 'Welcome, Student!';
                document.getElementById('userRole').textContent = 'Student Portal';
                document.getElementById('userAvatar').textContent = 'S';
                document.getElementById('studentNotice').classList.remove('hidden');
                document.getElementById('addStudentBtn').classList.add('hidden');
                document.getElementById('addTestBtn').classList.add('hidden');
                document.getElementById('attendanceActions').classList.add('hidden');
            }
        }

        function showSection(sectionId) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Find the clicked tab and activate it
            const clickedTab = event.currentTarget;
            clickedTab.classList.add('active');
            
            // Show section
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Load specific data for the section
            loadSectionData(sectionId);
        }

        async function loadSectionData(sectionId) {
            try {
                if (sectionId === 'dashboard') {
                    if (userRole === 'teacher') {
                        await loadDashboardData();
                    } else {
                        await loadStudentDashboardData();
                    }
                } else if (sectionId === 'students') {
                    await loadStudents();
                } else if (sectionId === 'attendance') {
                    await loadAttendanceTable();
                } else if (sectionId === 'tests') {
                    await loadTests();
                } else if (sectionId === 'feedback') {
                    await loadFeedback();
                } else if (sectionId === 'about') {
                    await loadTeacherProfile();
                }
            } catch (error) {
                console.error(`Error loading section ${sectionId}:`, error);
                showToast('Error loading data');
            }
        }

        // Data Loading Functions
        async function loadTeacherData() {
            try {
                showLoading('studentsList', 'Loading students...');
                showLoading('testsList', 'Loading tests...');
                showLoading('feedbackList', 'Loading feedback...');
                
                // Load dashboard data first (which loads students)
                await loadDashboardData();
                
                // Load other sections
                await loadStudents();
                await loadAttendanceTable();
                await loadTests();
                await loadFeedback();
                await loadTeacherProfile();
                
            } catch (error) {
                console.error('Error loading teacher data:', error);
                showToast('Error loading data: ' + error.message);
            }
        }

        async function loadStudentData() {
            try {
                showLoading('studentsList', 'Loading students...');
                showLoading('testsList', 'Loading tests...');
                showLoading('feedbackList', 'Loading feedback...');
                
                // Load dashboard data first (which loads students)
                await loadStudentDashboardData();
                
                // Load other sections
                await loadStudents();
                await loadAttendanceTable();
                await loadTests();
                await loadFeedback();
                await loadTeacherProfile();
                
            } catch (error) {
                console.error('Error loading student data:', error);
                showToast('Error loading data: ' + error.message);
            }
        }

        async function loadDashboardData() {
            try {
                // Load students
                const studentsSnapshot = await db.collection('students').get();
                allStudents = [];
                studentsSnapshot.forEach(doc => {
                    allStudents.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                document.getElementById('totalStudents').textContent = allStudents.length;

                // Load today's attendance
                const today = new Date().toISOString().split('T')[0];
                const attendanceSnapshot = await db.collection('attendance')
                    .where('date', '==', today)
                    .get();

                let presentCount = 0;
                todayAttendance = {};
                attendanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    todayAttendance[data.studentId] = data.status;
                    if (data.status === 'present') presentCount++;
                });

                const attendancePercent = allStudents.length > 0 
                    ? Math.round((presentCount / allStudents.length) * 100) 
                    : 0;
                document.getElementById('attendancePercent').textContent = attendancePercent + '%';

                // Calculate fees only for teacher
                let totalPendingFees = 0;
                allStudents.forEach(student => {
                    totalPendingFees += parseFloat(student.feePending || 0);
                });

                // Load collected fees for current month
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                const firstDay = new Date(currentYear, currentMonth - 1, 1);
                const lastDay = new Date(currentYear, currentMonth, 0);

                const feesSnapshot = await db.collection('fees')
                    .where('date', '>=', firstDay)
                    .where('date', '<=', lastDay)
                    .get();

                let collectedFees = 0;
                feesSnapshot.forEach(doc => {
                    collectedFees += parseFloat(doc.data().amount || 0);
                });

                document.getElementById('feesCollected').textContent = '₹' + collectedFees;
                document.getElementById('pendingFees').textContent = '₹' + totalPendingFees;

                // Load activities
                await loadActivities();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Error loading dashboard: ' + error.message);
            }
        }

        async function loadStudentDashboardData() {
            try {
                // Load students
                const studentsSnapshot = await db.collection('students').get();
                allStudents = [];
                studentsSnapshot.forEach(doc => {
                    allStudents.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                document.getElementById('totalStudents').textContent = allStudents.length;

                // Load today's attendance
                const today = new Date().toISOString().split('T')[0];
                const attendanceSnapshot = await db.collection('attendance')
                    .where('date', '==', today)
                    .get();

                let presentCount = 0;
                todayAttendance = {};
                attendanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    todayAttendance[data.studentId] = data.status;
                    if (data.status === 'present') presentCount++;
                });

                const attendancePercent = allStudents.length > 0 
                    ? Math.round((presentCount / allStudents.length) * 100) 
                    : 0;
                document.getElementById('attendancePercent').textContent = attendancePercent + '%';

                // Student view - don't show fees
                document.getElementById('feesCollected').textContent = 'N/A';
                document.getElementById('pendingFees').textContent = 'N/A';

                // Load activities
                await loadActivities();

            } catch (error) {
                console.error('Error loading student dashboard data:', error);
                showToast('Error loading dashboard: ' + error.message);
            }
        }

        async function loadStudents() {
            const container = document.getElementById('studentsList');
            
            if (!allStudents || allStudents.length === 0) {
                container.innerHTML = '<div class="text-center p-4">No students found</div>';
                return;
            }

            let html = '';
            allStudents.forEach(student => {
                const firstLetter = student.name ? student.name.charAt(0).toUpperCase() : 'S';
                
                if (userRole === 'teacher') {
                    html += `
                        <div class="student-card">
                            <div class="student-header">
                                <div class="student-avatar">${firstLetter}</div>
                                <div class="student-info">
                                    <h3>${student.name}</h3>
                                    <p>Grade ${student.class}</p>
                                </div>
                            </div>
                            <div class="student-details">
                                <div class="detail-item">
                                    <div class="detail-label">Father's Name</div>
                                    <div class="detail-value">${student.fatherName || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Mobile</div>
                                    <div class="detail-value">${student.mobile || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Monthly Fee</div>
                                    <div class="detail-value">₹${student.monthlyFee || 0}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Pending Fee</div>
                                    <div class="detail-value">₹${student.feePending || 0}</div>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-secondary" onclick="editStudent('${student.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="collectFee('${student.id}', '${student.name}')">
                                    <i class="fas fa-rupee-sign"></i> Collect Fee
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="student-card">
                            <div class="student-header">
                                <div class="student-avatar">${firstLetter}</div>
                                <div class="student-info">
                                    <h3>${student.name}</h3>
                                    <p>Grade ${student.class}</p>
                                </div>
                            </div>
                            <div class="student-details">
                                <div class="detail-item">
                                    <div class="detail-label">Father's Name</div>
                                    <div class="detail-value">${student.fatherName || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Mobile</div>
                                    <div class="detail-value">${student.mobile || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Joined On</div>
                                    <div class="detail-value">${student.createdAt ? new Date(student.createdAt.seconds * 1000).toLocaleDateString() : 'Recently'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
            
            // Add search functionality for teacher
            if (userRole === 'teacher') {
                const searchInput = document.getElementById('studentSearch');
                if (searchInput) {
                    // Remove existing event listeners
                    searchInput.replaceWith(searchInput.cloneNode(true));
                    
                    // Get new reference
                    const newSearchInput = document.getElementById('studentSearch');
                    newSearchInput.addEventListener('input', function(e) {
                        const searchTerm = e.target.value.toLowerCase();
                        const filteredStudents = allStudents.filter(student => 
                            (student.name && student.name.toLowerCase().includes(searchTerm)) ||
                            (student.fatherName && student.fatherName.toLowerCase().includes(searchTerm)) ||
                            (student.class && student.class.toString().includes(searchTerm))
                        );
                        renderFilteredStudents(filteredStudents);
                    });
                }
            }
        }

        function renderFilteredStudents(students) {
            const container = document.getElementById('studentsList');
            if (students.length === 0) {
                container.innerHTML = '<div class="text-center p-4">No students found</div>';
                return;
            }

            let html = '';
            students.forEach(student => {
                const firstLetter = student.name ? student.name.charAt(0).toUpperCase() : 'S';
                
                if (userRole === 'teacher') {
                    html += `
                        <div class="student-card">
                            <div class="student-header">
                                <div class="student-avatar">${firstLetter}</div>
                                <div class="student-info">
                                    <h3>${student.name}</h3>
                                    <p>Grade ${student.class}</p>
                                </div>
                            </div>
                            <div class="student-details">
                                <div class="detail-item">
                                    <div class="detail-label">Father's Name</div>
                                    <div class="detail-value">${student.fatherName || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Mobile</div>
                                    <div class="detail-value">${student.mobile || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Monthly Fee</div>
                                    <div class="detail-value">₹${student.monthlyFee || 0}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Pending Fee</div>
                                    <div class="detail-value">₹${student.feePending || 0}</div>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-secondary" onclick="editStudent('${student.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-success" onclick="collectFee('${student.id}', '${student.name}')">
                                    <i class="fas fa-rupee-sign"></i> Collect Fee
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="student-card">
                            <div class="student-header">
                                <div class="student-avatar">${firstLetter}</div>
                                <div class="student-info">
                                    <h3>${student.name}</h3>
                                    <p>Grade ${student.class}</p>
                                </div>
                            </div>
                            <div class="student-details">
                                <div class="detail-item">
                                    <div class="detail-label">Father's Name</div>
                                    <div class="detail-value">${student.fatherName || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Mobile</div>
                                    <div class="detail-value">${student.mobile || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Joined On</div>
                                    <div class="detail-value">${student.createdAt ? new Date(student.createdAt.seconds * 1000).toLocaleDateString() : 'Recently'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        async function loadTests() {
            try {
                const testsSnapshot = await db.collection('tests').orderBy('date', 'desc').get();
                const container = document.getElementById('testsList');

                if (testsSnapshot.empty) {
                    container.innerHTML = '<div class="text-center p-4">No tests available</div>';
                    return;
                }

                let html = '';
                testsSnapshot.forEach(doc => {
                    const test = doc.data();
                    const testDate = test.date ? new Date(test.date.seconds * 1000).toLocaleDateString() : 'Not specified';
                    
                    html += `
                        <div class="test-card">
                            <div class="test-header">
                                <div class="test-title">${test.title}</div>
                                <div class="test-class">Grade ${test.class === 'all' ? 'All' : test.class}</div>
                            </div>
                            <div class="test-meta">
                                <i class="fas fa-calendar"></i> ${testDate}
                            </div>
                            <div class="test-actions">
                                <button class="btn btn-primary" onclick="window.open('${test.link}', '_blank')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                                ${userRole === 'teacher' ? `
                                <button class="btn btn-danger" onclick="deleteTest('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>` : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading tests:', error);
                showToast('Error loading tests: ' + error.message);
            }
        }

        async function loadFeedback() {
            try {
                const feedbackSnapshot = await db.collection('feedback').orderBy('timestamp', 'desc').limit(10).get();
                const container = document.getElementById('feedbackList');

                if (feedbackSnapshot.empty) {
                    container.innerHTML = '<div class="text-center p-4">No feedback yet</div>';
                    return;
                }

                let html = '';
                feedbackSnapshot.forEach(doc => {
                    const feedback = doc.data();
                    const date = feedback.timestamp ? new Date(feedback.timestamp.seconds * 1000).toLocaleDateString() : 'Recently';
                    const stars = '★'.repeat(feedback.rating) + '☆'.repeat(5 - feedback.rating);
                    
                    html += `
                        <div class="feedback-item">
                            <div class="feedback-header">
                                <div class="feedback-author">
                                    <h4>${feedback.name || 'Anonymous'}</h4>
                                    ${feedback.phone ? `<small class="text-muted">${feedback.phone}</small>` : ''}
                                </div>
                                <div class="feedback-date">${date}</div>
                            </div>
                            <div class="feedback-stars">
                                ${stars} (${feedback.rating}/5)
                            </div>
                            <div class="feedback-content">
                                ${feedback.text || 'No comment provided'}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading feedback:', error);
            }
        }

        async function loadTeacherProfile() {
            try {
                const profileDoc = await db.collection('teacherProfile').doc('profile').get();
                if (profileDoc.exists) {
                    const data = profileDoc.data();
                    
                    // Update display
                    document.getElementById('teacherName').textContent = data.name || 'Mr. Mithilesh';
                    document.getElementById('teacherEmail').textContent = data.email || 'mithilesh.maths@gmail.com';
                    document.getElementById('experienceText').textContent = data.experience || '';
                    
                    // Update qualifications
                    const qualificationsList = document.getElementById('qualificationsList');
                    if (qualificationsList) {
                        qualificationsList.innerHTML = '';
                        if (data.qualifications && Array.isArray(data.qualifications)) {
                            data.qualifications.forEach(qual => {
                                const li = document.createElement('li');
                                li.textContent = qual;
                                qualificationsList.appendChild(li);
                            });
                        }
                    }
                    
                    // Update achievements
                    const achievementsList = document.getElementById('achievementsList');
                    if (achievementsList) {
                        achievementsList.innerHTML = '';
                        if (data.achievements && Array.isArray(data.achievements)) {
                            data.achievements.forEach(ach => {
                                const li = document.createElement('li');
                                li.textContent = ach;
                                achievementsList.appendChild(li);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading teacher profile:', error);
            }
        }

        async function loadAttendanceTable() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const oneMonthAgo = new Date();
                oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);

                // Get attendance data
                const todaySnapshot = await db.collection('attendance')
                    .where('date', '==', today)
                    .get();

                const weekSnapshot = await db.collection('attendance')
                    .where('date', '>=', oneWeekAgo.toISOString().split('T')[0])
                    .where('date', '<=', today)
                    .get();

                const monthSnapshot = await db.collection('attendance')
                    .where('date', '>=', oneMonthAgo.toISOString().split('T')[0])
                    .where('date', '<=', today)
                    .get();

                // Process data
                const attendanceData = {};
                allStudents.forEach(student => {
                    attendanceData[student.id] = {
                        name: student.name,
                        class: student.class,
                        today: 'absent',
                        weekPresent: 0,
                        weekTotal: 0,
                        monthPresent: 0,
                        monthTotal: 0
                    };
                });

                // Today's attendance
                todaySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (attendanceData[data.studentId]) {
                        attendanceData[data.studentId].today = data.status;
                    }
                });

                // Week's attendance
                weekSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (attendanceData[data.studentId]) {
                        attendanceData[data.studentId].weekTotal++;
                        if (data.status === 'present') {
                            attendanceData[data.studentId].weekPresent++;
                        }
                    }
                });

                // Month's attendance
                monthSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (attendanceData[data.studentId]) {
                        attendanceData[data.studentId].monthTotal++;
                        if (data.status === 'present') {
                            attendanceData[data.studentId].monthPresent++;
                        }
                    }
                });

                // Generate table
                let html = '';
                Object.keys(attendanceData).forEach(studentId => {
                    const data = attendanceData[studentId];
                    const weekPercent = data.weekTotal > 0 ? Math.round((data.weekPresent / data.weekTotal) * 100) : 0;
                    const monthPercent = data.monthTotal > 0 ? Math.round((data.monthPresent / data.monthTotal) * 100) : 0;
                    const overallPercent = Math.round((weekPercent + monthPercent) / 2);

                    html += `
                        <tr>
                            <td>${data.name}</td>
                            <td>Grade ${data.class}</td>
                            <td>
                                <span class="attendance-status ${data.today === 'present' ? 'status-present' : 'status-absent'}">
                                    ${data.today}
                                </span>
                            </td>
                            <td>${data.weekPresent}/${data.weekTotal}</td>
                            <td>${data.monthPresent}/${data.monthTotal}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span>${overallPercent}%</span>
                                    <div class="progress-bar" style="flex: 1;">
                                        <div class="progress-fill" style="width: ${overallPercent}%; background: ${overallPercent > 80 ? 'var(--success)' : overallPercent > 60 ? 'var(--warning)' : 'var(--danger)'};"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('attendanceTable').innerHTML = html;
            } catch (error) {
                console.error('Error loading attendance:', error);
                document.getElementById('attendanceTable').innerHTML = '<tr><td colspan="6" class="text-center p-4">Error loading attendance</td></tr>';
            }
        }

        async function loadActivities() {
            try {
                // For teacher: Show actual activities from database
                if (userRole === 'teacher') {
                    // Get recent activities from various collections
                    const activities = [];
                    
                    // Get recent student additions
                    const recentStudents = await db.collection('students')
                        .orderBy('createdAt', 'desc')
                        .limit(3)
                        .get();
                    
                    recentStudents.forEach(doc => {
                        const student = doc.data();
                        activities.push({
                            date: student.createdAt ? new Date(student.createdAt.seconds * 1000).toLocaleDateString() : 'Today',
                            activity: `New student registered: ${student.name}`,
                            status: 'Completed'
                        });
                    });
                    
                    // Get recent test uploads
                    const recentTests = await db.collection('tests')
                        .orderBy('createdAt', 'desc')
                        .limit(2)
                        .get();
                    
                    recentTests.forEach(doc => {
                        const test = doc.data();
                        activities.push({
                            date: test.createdAt ? new Date(test.createdAt.seconds * 1000).toLocaleDateString() : 'Today',
                            activity: `Test uploaded: ${test.title}`,
                            status: 'Completed'
                        });
                    });

                    let html = '';
                    activities.forEach(activity => {
                        const statusClass = activity.status === 'Completed' ? 'badge-success' : 'badge-warning';
                        html += `
                            <tr>
                                <td>${activity.date}</td>
                                <td>${activity.activity}</td>
                                <td><span class="badge ${statusClass}">${activity.status}</span></td>
                            </tr>
                        `;
                    });

                    document.getElementById('activitiesList').innerHTML = html;
                } else {
                    // For student: Show sample activities
                    const activities = [
                        { date: 'Today', activity: 'Algebra class completed', status: 'Attended' },
                        { date: 'Yesterday', activity: 'Test submitted successfully', status: 'Completed' },
                        { date: '3 days ago', activity: 'Study material downloaded', status: 'Completed' }
                    ];

                    let html = '';
                    activities.forEach(activity => {
                        const statusClass = activity.status === 'Completed' || activity.status === 'Attended' ? 'badge-success' : 'badge-warning';
                        html += `
                            <tr>
                                <td>${activity.date}</td>
                                <td>${activity.activity}</td>
                                <td><span class="badge ${statusClass}">${activity.status}</span></td>
                            </tr>
                        `;
                    });

                    document.getElementById('activitiesList').innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        // Student Management
        async function addStudent() {
            if (userRole !== 'teacher') return;

            const studentData = {
                name: document.getElementById('studentName').value.trim(),
                fatherName: document.getElementById('fatherName').value.trim(),
                class: document.getElementById('studentClass').value,
                mobile: document.getElementById('studentMobile').value.trim(),
                monthlyFee: parseFloat(document.getElementById('monthlyFee').value) || 0,
                feePending: parseFloat(document.getElementById('monthlyFee').value) || 0,
                createdAt: new Date()
            };

            if (!studentData.name) {
                showToast('Please enter student name');
                return;
            }

            if (!studentData.fatherName) {
                showToast('Please enter father\'s name');
                return;
            }

            if (!studentData.mobile) {
                showToast('Please enter mobile number');
                return;
            }

            try {
                await db.collection('students').add(studentData);
                closeModal('addStudentModal');
                showToast('Student added successfully!');
                // Clear form
                document.getElementById('studentName').value = '';
                document.getElementById('fatherName').value = '';
                document.getElementById('studentMobile').value = '';
                document.getElementById('monthlyFee').value = '';
                // Reload data
                await loadTeacherData();
            } catch (error) {
                showToast('Error adding student: ' + error.message);
            }
        }

        async function deleteStudent(studentId) {
            if (userRole !== 'teacher') return;
            if (confirm('Are you sure you want to delete this student?')) {
                try {
                    await db.collection('students').doc(studentId).delete();
                    showToast('Student deleted successfully!');
                    // Reload data
                    await loadTeacherData();
                } catch (error) {
                    showToast('Error deleting student: ' + error.message);
                }
            }
        }

        // Test Management
        async function addTest() {
            if (userRole !== 'teacher') return;

            const testData = {
                title: document.getElementById('testTitle').value.trim(),
                class: document.getElementById('testClass').value,
                date: new Date(document.getElementById('testDate').value || new Date()),
                link: document.getElementById('testLink').value.trim(),
                createdAt: new Date()
            };

            if (!testData.title || !testData.link) {
                showToast('Please fill all required fields');
                return;
            }

            try {
                await db.collection('tests').add(testData);
                closeModal('addTestModal');
                showToast('Test added successfully!');
                // Clear form
                document.getElementById('testTitle').value = '';
                document.getElementById('testLink').value = '';
                // Reload tests
                await loadTests();
            } catch (error) {
                showToast('Error adding test: ' + error.message);
            }
        }

        async function deleteTest(testId) {
            if (userRole !== 'teacher') return;
            if (confirm('Are you sure you want to delete this test?')) {
                try {
                    await db.collection('tests').doc(testId).delete();
                    showToast('Test deleted successfully!');
                    await loadTests();
                } catch (error) {
                    showToast('Error deleting test: ' + error.message);
                }
            }
        }

        // Feedback
        async function submitFeedback() {
            const rating = document.querySelector('input[name="rating"]:checked');
            const name = document.getElementById('feedbackName').value.trim();
            const phone = document.getElementById('feedbackPhone').value.trim();
            const text = document.getElementById('feedbackText').value.trim();

            if (!rating) {
                showToast('Please select a rating');
                return;
            }

            if (!name) {
                showToast('Please enter your name');
                return;
            }

            try {
                await db.collection('feedback').add({
                    rating: parseInt(rating.value),
                    name: name,
                    phone: phone || '',
                    text: text || '',
                    timestamp: new Date()
                });

                // Reset form
                document.querySelectorAll('input[name="rating"]').forEach(input => input.checked = false);
                document.getElementById('feedbackName').value = '';
                document.getElementById('feedbackPhone').value = '';
                document.getElementById('feedbackText').value = '';
                document.getElementById('ratingText').textContent = 'Select your rating';

                showToast('Thank you for your feedback!');
                await loadFeedback();

            } catch (error) {
                showToast('Error submitting feedback: ' + error.message);
            }
        }

        // Attendance Management
        async function openAttendanceModal() {
            if (userRole !== 'teacher') return;

            let html = '';
            allStudents.forEach(student => {
                const isPresent = todayAttendance[student.id] === 'present';
                const isAbsent = todayAttendance[student.id] === 'absent';

                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border);">
                        <div>
                            <strong>${student.name}</strong>
                            <div class="text-muted" style="font-size: 12px;">Grade ${student.class}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-sm ${isPresent ? 'btn-success' : 'btn-secondary'}" onclick="markStudentAttendance('${student.id}', 'present')">
                                Present
                            </button>
                            <button class="btn btn-sm ${isAbsent ? 'btn-danger' : 'btn-secondary'}" onclick="markStudentAttendance('${student.id}', 'absent')">
                                Absent
                            </button>
                        </div>
                    </div>
                `;
            });

            document.getElementById('attendanceList').innerHTML = html;
            document.getElementById('attendanceModal').classList.add('active');
        }

        async function markStudentAttendance(studentId, status) {
            const today = new Date().toISOString().split('T')[0];

            try {
                // Check if attendance already exists
                const existing = await db.collection('attendance')
                    .where('studentId', '==', studentId)
                    .where('date', '==', today)
                    .get();

                if (!existing.empty) {
                    await db.collection('attendance').doc(existing.docs[0].id).update({
                        status: status,
                        updatedAt: new Date()
                    });
                } else {
                    await db.collection('attendance').add({
                        studentId: studentId,
                        date: today,
                        status: status,
                        createdAt: new Date()
                    });
                }

                todayAttendance[studentId] = status;
                showToast(`Attendance marked as ${status}`);
                // Refresh modal
                openAttendanceModal();

            } catch (error) {
                showToast('Error marking attendance: ' + error.message);
            }
        }

        async function saveAttendance() {
            closeModal('attendanceModal');
            showToast('Attendance saved successfully!');
            await loadDashboardData();
            await loadAttendanceTable();
        }

        // Modal Functions
        function openAddStudentModal() {
            if (userRole !== 'teacher') return;
            document.getElementById('addStudentModal').classList.add('active');
        }

        function openAddTestModal() {
            if (userRole !== 'teacher') return;
            document.getElementById('testDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addTestModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Helper Functions
        function showLoading(containerId, message = 'Loading...') {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        function showLoadingState(message) {
            // Show loading state on login screen
            const loginCard = document.querySelector('.login-card');
            const originalContent = loginCard.innerHTML;
            loginCard.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>${message}</p>
                </div>
            `;
            return originalContent;
        }

        // Utility Functions
        function logout() {
            localStorage.removeItem('userMode');
            localStorage.removeItem('teacherLoggedIn');
            auth.signOut();
            setTimeout(() => {
                location.reload();
            }, 500);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Helper functions for student actions
        async function editStudent(studentId) {
            showToast('Edit feature coming soon!');
        }

        async function collectFee(studentId, studentName) {
            const amount = prompt(`Enter amount to collect for ${studentName}:`, "0");
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                try {
                    await db.collection('fees').add({
                        studentId: studentId,
                        studentName: studentName,
                        amount: parseFloat(amount),
                        date: new Date(),
                        createdAt: new Date()
                    });
                    
                    // Update student's pending fee
                    const studentDoc = await db.collection('students').doc(studentId).get();
                    if (studentDoc.exists) {
                        const studentData = studentDoc.data();
                        const currentPending = parseFloat(studentData.feePending || 0);
                        const newPending = Math.max(0, currentPending - parseFloat(amount));
                        
                        await db.collection('students').doc(studentId).update({
                            feePending: newPending
                        });
                    }
                    
                    showToast(`Fee of ₹${amount} collected successfully!`);
                    await loadTeacherData();
                } catch (error) {
                    showToast('Error collecting fee: ' + error.message);
                }
            }
        }
    </script>
</body>
    </html>
